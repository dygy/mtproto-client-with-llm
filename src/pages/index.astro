---
import Layout from '../layouts/Layout.astro';
---

<Layout title="MTProto Telegram Client">
  <div class="min-h-[calc(100vh-200px)] flex items-center justify-center">
    <div id="session-selector-app"></div>
  </div>
</Layout>

<script>
  import React from 'react';
  import { createRoot } from 'react-dom/client';

  // Session Selector React Component
  function SessionSelector() {
    const [sessions, setSessions] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const [error, setError] = React.useState(null);
    const [selectedSession, setSelectedSession] = React.useState(null);
    const [sessionPassword, setSessionPassword] = React.useState('');
    const [passwordError, setPasswordError] = React.useState('');
    const [verifying, setVerifying] = React.useState(false);

    React.useEffect(() => {
      loadSessions();
    }, []);

    const loadSessions = async () => {
      try {
        setLoading(true);
        const response = await fetch('/api/sessions');
        const data = await response.json();

        if (data.success) {
          setSessions(data.sessions || []);
        } else {
          setError(data.message || 'Failed to load sessions');
        }
      } catch (err) {
        console.error('Error loading sessions:', err);
        setError('Failed to load sessions');
      } finally {
        setLoading(false);
      }
    };

    const handleSessionSelect = async (sessionId) => {
      // Check if we already have unlock token for this session
      const unlockToken = localStorage.getItem(`session_unlock_${sessionId}`);

      if (unlockToken) {
        // Already unlocked, go directly to chat
        window.location.href = `/chat?session=${sessionId}`;
      } else {
        // Need password, show password prompt
        setSelectedSession(sessionId);
        setSessionPassword('');
        setPasswordError('');
      }
    };

    const handlePasswordSubmit = async (e) => {
      e.preventDefault();
      setVerifying(true);
      setPasswordError('');

      try {
        const response = await fetch('/api/auth/verify-session-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionId: selectedSession,
            password: sessionPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          // Store unlock token
          localStorage.setItem(`session_unlock_${selectedSession}`, sessionPassword);

          // Redirect to chat
          window.location.href = `/chat?session=${selectedSession}`;
        } else {
          setPasswordError(data.message || 'Invalid password');
          setSessionPassword('');
        }
      } catch (err) {
        setPasswordError('Failed to verify password');
        setSessionPassword('');
      } finally {
        setVerifying(false);
      }
    };

    const handleCancelPassword = () => {
      setSelectedSession(null);
      setSessionPassword('');
      setPasswordError('');
    };

    const formatDate = (dateString) => {
      try {
        return new Date(dateString).toLocaleDateString();
      } catch {
        return 'Unknown';
      }
    };

    if (loading) {
      return React.createElement('div', { className: 'layout-centered container-elevated p-6' },
        React.createElement('div', { className: 'text-center' },
          React.createElement('div', { className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4' }),
          React.createElement('p', { className: 'text-gray-600 dark:text-gray-400' }, 'Loading sessions...')
        )
      );
    }

    if (error) {
      return React.createElement('div', { className: 'layout-centered container-elevated p-6' },
        React.createElement('div', { className: 'text-center' },
          React.createElement('p', { className: 'text-red-600 dark:text-red-400 mb-4' }, error),
          React.createElement('button', {
            onClick: loadSessions,
            className: 'btn btn-primary'
          }, 'Retry')
        )
      );
    }

    // Show password prompt if session is selected
    if (selectedSession) {
      return React.createElement('div', { className: 'layout-centered container-elevated p-6' },
        React.createElement('div', { className: 'text-center mb-6' },
          React.createElement('div', { className: 'text-5xl mb-4' }, 'ðŸ”’'),
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white mb-2' }, 'Session Password Required'),
          React.createElement('p', { className: 'text-gray-600 dark:text-gray-400' },
            'Enter the password for this session'
          )
        ),

        React.createElement('form', { onSubmit: handlePasswordSubmit, className: 'space-y-4' },
          React.createElement('div', null,
            React.createElement('label', { htmlFor: 'session-password', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' }, 'Password'),
            React.createElement('input', {
              type: 'password',
              id: 'session-password',
              value: sessionPassword,
              onChange: (e) => setSessionPassword(e.target.value),
              placeholder: 'Enter session password',
              className: 'input',
              required: true,
              disabled: verifying,
              autoFocus: true
            })
          ),

          passwordError && React.createElement('div', { className: 'p-3 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700 rounded-md' },
            React.createElement('p', { className: 'text-red-700 dark:text-red-400 text-sm' }, passwordError)
          ),

          React.createElement('div', { className: 'flex space-x-3' },
            React.createElement('button', {
              type: 'button',
              onClick: handleCancelPassword,
              className: 'flex-1 btn btn-secondary',
              disabled: verifying
            }, 'Cancel'),
            React.createElement('button', {
              type: 'submit',
              className: 'flex-1 btn btn-primary',
              disabled: verifying || !sessionPassword
            }, verifying ? 'Verifying...' : 'Unlock')
          )
        )
      );
    }

    return React.createElement('div', { className: 'layout-centered container-elevated p-6' },
      sessions.length > 0 ?
        React.createElement('div', null,
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white mb-4' }, 'Choose Your Session'),
          React.createElement('p', { className: 'text-gray-600 dark:text-gray-400 mb-6' }, 'Select an existing session to continue'),

          React.createElement('div', { className: 'space-y-3 mb-6' },
            sessions.slice(0, 5).map((session) =>
              React.createElement('button', {
                key: session.sessionId,
                onClick: () => handleSessionSelect(session.sessionId),
                className: 'w-full p-4 text-left border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors'
              },
                React.createElement('div', { className: 'flex items-center space-x-3' },
                  React.createElement('div', { className: 'w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium' },
                    session.userInfo?.firstName?.charAt(0) || '?'
                  ),
                  React.createElement('div', { className: 'flex-1' },
                    React.createElement('div', { className: 'font-medium text-gray-900 dark:text-white' },
                      `${session.userInfo?.firstName || 'Unknown'} ${session.userInfo?.lastName || ''}`
                    ),
                    React.createElement('div', { className: 'text-sm text-gray-500 dark:text-gray-400 truncate max-w-full overflow-hidden' },
                      session.phoneNumber + (session.userInfo?.username ? ` â€¢ @${session.userInfo.username}` : '')
                    ),
                    React.createElement('div', { className: 'text-xs text-gray-400 dark:text-gray-500' },
                      `Last active: ${formatDate(session.lastActive)}`
                    )
                  )
                )
              )
            )
          ),

          sessions.length > 5 && React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400 mb-4' },
            `Showing 5 of ${sessions.length} sessions`
          ),

          React.createElement('div', { className: 'text-center' },
            React.createElement('a', {
              href: '/login',
              className: 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm inline-block',
              'data-astro-prefetch': 'hover'
            }, 'Create New Session')
          )
        ) :
        React.createElement('div', { className: 'text-center' },
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white mb-4' }, 'Welcome to Telegram Client'),
          React.createElement('p', { className: 'text-gray-600 dark:text-gray-400 mb-6' },
            'No active sessions found. Create a new session to get started.'
          ),
          React.createElement('a', {
            href: '/login',
            className: 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm inline-block',
            'data-astro-prefetch': 'hover'
          }, 'Create New Session')
        )
    );
  }

  // Initialize React app
  function initSessionSelector() {
    const container = document.getElementById('session-selector-app');
    if (container && !container.hasAttribute('data-initialized')) {
      container.setAttribute('data-initialized', 'true');
      const root = createRoot(container);
      root.render(React.createElement(SessionSelector));
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initSessionSelector);

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:page-load', initSessionSelector);

  // Also try immediate initialization in case script loads after DOM
  if (document.readyState === 'loading') {
    // DOM is still loading
  } else {
    // DOM is already ready
    initSessionSelector();
  }
</script>
